var gH=function(){var e={},t=jQuery,r="hide";return{gallery:function(r,a,n,s){var i;(i=t("#"+r+"pad"))&&(e[r]={insertOnly:s,builderOn:s?!0:!1,imageUrl:a,cacheUrl:n,selected:{},currentImages:null,imageIndex:null,selectOrder:[],changed:{},currentOffset:0,currentLimit:0,showingCurrent:!1,idsOnly:!1,pad:i,folders:t("#"+r+"folders"),recurse:t("#"+r+"recurse"),start:t("#"+r+"start"),end:t("#"+r+"end"),name:t("#"+r+"name"),title:t("#"+r+"title"),comment:t("#"+r+"comment"),tags:t("#"+r+"tags"),filter:t("#"+r+"filter"),filterButton:t("#"+r+"filterButton"),saveButton:t("#"+r+"saveButton"),filterLabel:t("#"+r+"filterLabel"),builder:t("#"+r+"builder"),builderLabel:t("#"+r+"builderLabel"),limit:t("#"+r+"limit"),shortcode:t("#"+r+"shortcode"),selectedLabel:t("#"+r+"selectedLabel"),sctype:t("#"+r+"sctype"),pages:t("#"+r+"pages")},isNaN(e[r].currentLimit=parseInt(e[r].limit.val()))&&(e[r].currentLimit=50,e[r].limit.val(50)),e[r].folders.multiselect({noneSelectedText:"Select folders",selectedText:"# folders selected"}),e[r].start.datetimepicker({timeFormat:"HH:mm",dateFormat:"yy-mm-dd",stepMinute:10,controlType:"select",onClose:function(){if(""!=e[r].end.val()){var t=e[r].start.datetimepicker("getDate"),a=e[r].end.datetimepicker("getDate");t>a&&e[r].end.datetimepicker("setDate",t)}},onSelect:function(){e[r].end.datetimepicker("option","minDate",e[r].start.datetimepicker("getDate"))}}),e[r].end.datetimepicker({timeFormat:"HH:mm",dateFormat:"yy-mm-dd",stepMinute:10,controlType:"select",onClose:function(){if(""!=e[r].start.val()){var t=e[r].start.datetimepicker("getDate"),a=e[r].end.datetimepicker("getDate");t>a&&e[r].start.datetimepicker("setDate",a)}},onSelect:function(){e[r].start.datetimepicker("option","maxDate",e[r].end.datetimepicker("getDate"))}})),this.compileShortcode(r)},toggle:function(t,a,n,s,i){return e[t]?(s||(s="Show"),i||(i="Hide"),e[t]&&e[t][a]?e[t][a].hasClass(r)?(e[t][a].removeClass(r),e[t][a+"Label"].html(i+" "+n),!0):(e[t][a].addClass(r),e[t][a+"Label"].html(s+" "+n),!1):void 0):void 0},thumbnail:function(e){return e.replace(/\//g,"_")},filter:function(r){if(e[r]){e[r].query||(e[r].query={folders:[],recurse:!1,start:"",end:"",name:"",title:"",comment:"",tags:""});var a,n,s,i=!1;for(a in e[r].query)if("folders"==a){if(n=e[r][a].val(),null==e[r].query[a]&&null==n)continue;(null==e[r].query[a]||null==n||e[r].query[a].length!=n.length)&&(e[r].query[a]=n,i=!0);for(s in e[r].query[a])e[r].query[a][s]!=n[s]&&(e[r].query[a]=n,i=!0)}else"checkbox"==e[r][a].prop("type")?(n=e[r][a].prop("checked"),(e[r].query[a]?n:!n)&&(e[r].query[a]=n,i=!0)):e[r].query[a]!=(n=e[r][a].val())&&(e[r].query[a]=n,i=!0);i&&(e[r].filterButton.html("Loading..."),t.post(ajaxurl+"?action=gh_gallery",e[r].query,this.returnFunction(this.receiveData,r)))}},toggleBuilder:function(t){e[t]&&(e[t].insertOnly?this.toggle(t,"builder","shortcode"):(e[t].builderOn=this.toggle(t,"builder","shortcode builder","Enable","Disable"))?e[t].pad.addClass("builderOn"):e[t].pad.removeClass("builderOn"))},receiveData:function(t,r){e[t]&&(e[t].imageData=r,e[t].filterButton.html("Filter"),this.setCurrentImages(t,e[t].imageData),this.printImages(t,0),e[t].idsOnly=!1,this.compileShortcode(t))},repage:function(t){if(e[t]){var r=parseInt(e[t].limit.val());isNaN(r)&&(e[t].limit.val("50"),r=50),e[t].currentLimit=r,e[t].currentImages&&(e[t].currentOffset=r?Math.floor(e[t].currentOffset/r)*r:0,this.printImages(t,e[t].currentOffset))}},changePage:function(t){if(e[t]){var r,a=Math.floor(e[t].currentOffset/e[t].currentLimit)+1,n=Math.floor(e[t].currentImages.length/e[t].currentLimit)+1;isNaN(r=parseInt(e[t].pageNumber.val()))?(r=a,e[t].pageNumber.val(r)):r>n?(r=n,e[t].pageNumber.val(r)):1>r&&(r=1,e[t].pageNumber.val(r)),r!=a&&(r=(r-1)*e[t].currentLimit,this.printImages(t,r))}},printImages:function(r,a){if(e[r]&&(isNaN(a=parseInt(a))&&(a=0),e[r].currentImages)){e[r].currentOffset=a,e[r].pad.html("");var n=Math.min(a+e[r].currentLimit,e[r].currentImages.length);a=Math.min(a,e[r].currentImages.length);var s;for(s=a;n>s;s++){var i,l,c,d=(e[r].currentImages[s].div=t(document.createElement("div"))).addClass("galleryThumb");d.append(c=t(document.createElement("a"))),c.attr("href",e[r].imageUrl+"/"+e[r].currentImages[s].file),c.attr("data-fancybox","fancybox"),c.attr("rel","thumbs"),c.attr("title","ID: "+e[r].currentImages[s].id+". Title: "+e[r].currentImages[s].title+". Comment: "+e[r].currentImages[s].comment),c.append(i=t(document.createElement("img"))),i.attr("src",e[r].cacheUrl+"/"+this.thumbnail(e[r].currentImages[s].file)),d.append(i=t(document.createElement("div"))),i.click(this.returnFunction(this.exclude,r,s)),i.addClass("exclude"),i.attr("title","Exclude from galleries by default"),d.append(i=t(document.createElement("div"))),i.addClass("select"),i.click(this.returnFunction(this.select,r,s)),i.attr("title","Include in selection"),d.append(i=t(document.createElement("div"))),i.addClass("orderer"),i.append(l=t(document.createElement("div"))),l.addClass("dashicons dashicons-arrow-left-alt"),l.click(this.returnFunction(this.order,r,s,-1)),i.append(e[r].currentImages[s].order=l=t(document.createElement("div"))),l.addClass("order"),i.append(l=t(document.createElement("div"))),l.addClass("dashicons dashicons-arrow-right-alt"),l.click(this.returnFunction(this.order,r,s,1)),!e[r].currentImages[s].exclude||"1"!==e[r].currentImages[s].exclude&&e[r].currentImages[s].exclude!==!0||d.addClass("excluded"),e[r].selected[e[r].currentImages[s].id]&&(d.addClass("selected"),e[r].currentImages[s].order.html(e[r].selectOrder.indexOf(e[r].currentImages[s].id)+1)),e[r].pad.append(d)}e[r].pages.html(""),e[r].pages.append(i=t(document.createElement("span"))),i.addClass("displaying-num"),i.html(e[r].currentImages.length+" items"),e[r].pages.append(i=t(document.createElement("a"))),0!==a?i.click(this.returnFunction(this.printImages,r,0)):i.addClass("disabled"),i.html("&laquo;"),i.addClass("first-page"),e[r].pages.append(i=t(document.createElement("a"))),0!==a?((s=a-n)<0&&(s=0),i.click(this.returnFunction(this.printImages,r,s))):i.addClass("disabled"),i.html("&lsaquo;"),i.addClass("prev-page"),e[r].pages.append(i=e[r].pageNumber=t(document.createElement("input"))),i.attr("type","number"),i.addClass("current-page"),i.attr("title","Current Page"),i.val(Math.ceil(a/e[r].currentLimit)+1),i.change(this.returnFunction(this.changePage,r)),e[r].pages.append(document.createTextNode(" of "));var u=Math.floor(e[r].currentImages.length/e[r].currentLimit),o=u*e[r].currentLimit;e[r].pages.append(i=t(document.createElement("span"))),i.addClass("total-pages"),i.html(u+1),e[r].pages.append(i=t(document.createElement("a"))),a!==o?((s=a+e[r].currentLimit)>o&&(s=o),i.click(this.returnFunction(this.printImages,r,s))):i.addClass("disabled"),i.html("&rsaquo;"),i.addClass("next-page"),e[r].pages.append(i=t(document.createElement("a"))),a!==o?i.click(this.returnFunction(this.printImages,r,o)):i.addClass("disabled"),i.html("&raquo;"),i.addClass("last-page"),t("a[data-fancybox='fancybox']").fancybox()}},setCurrentImages:function(t,r){if(e[t]){var a;e[t].currentImages=r,e[t].imageIndex={};for(a in e[t].currentImages)e[t].currentImages[a].id&&(e[t].imageIndex[e[t].currentImages[a].id]=a)}},toggleSelected:function(t){if(e[t]){var r;if(e[t].showingCurrent!==!1){for(r in e[t].selected)e[t].selected[r].selected||delete e[t].selected[r];this.setCurrentImages(t,e[t].imageData),e[t].selectedLabel.html("Show currently selected images"),this.printImages(t,e[t].showingCurrent),e[t].showingCurrent=!1}else{e[t].currentImages=[],e[t].imageIndex={};var r;for(r in e[t].selectOrder)e[t].currentImages[r]=e[t].selected[e[t].selectOrder[r]],e[t].imageIndex[e[t].selectOrder[r]]=r;e[t].showingCurrent=e[t].currentOffset,e[t].currentOffset=0,e[t].selectedLabel.html("Show filtered images"),this.printImages(t,e[t].showingCurrent)}}},returnFunction:function(e){var t=Array.prototype.slice.call(arguments);t.shift();var r=this;return function(){t=t.concat(Array.prototype.slice.call(arguments)),e.apply(r,t)}},clearSelected:function(t){if(e[t]&&e[t].selectOrder){var r,a;if(e[t].showingCurrent===!1)for(r in e[t].selectOrder)a=e[t].selectOrder[r],e[t].imageIndex[a]&&(a=e[t].imageIndex[a],e[t].currentImages[a].div.removeClass("selected"));e[t].selectOrder=[],e[t].selected={},e[t].showingCurrent!==!1&&this.toggleSelected(t),e[t].idsOnly=!1,this.compileShortcode(t)}},order:function(t,r,a){if(e[t]&&(-1===a||1===a)&&e[t].currentImages[r]){var n=e[t].currentImages[r].id,s=e[t].selectOrder.indexOf(n);if(-1===a&&0===s||1===a&&s===e[t].selectOrder.length-1)return;var i=e[t].selectOrder[s+a];e[t].selectOrder[s+a]=e[t].selectOrder[s],e[t].selectOrder[s]=i,e[t].imageIndex[i]&&e[t].currentImages[e[t].imageIndex[i]]&&e[t].currentImages[e[t].imageIndex[i]].order.html(s+1),e[t].currentImages[r].order.html(s+a+1),this.compileShortcode(t)}},compileShortcode:function(t){if(e[t]){var r="["+e[t].sctype.val(),a=[];if(e[t].selectOrder.length&&(a=e[t].selectOrder.slice(0)),!e[t].idsOnly){var n=e[t].folders.val();n&&a.push("folder="+n.join("|"));var s=e[t].start.val(),i=e[t].end.val();(s||i)&&a.push("taken="+(s?s:"")+"|"+(i?i:""));var l,c=["name","title","comment","tags"];for(p in c)(l=e[t][c[p]].val())&&a.push(c[p]+"="+l)}r+=' id="'+a.join(",")+'"',r+="]",e[t].shortcode.html(r)}},save:function(r){if(e[r]){var a,n,s={},i=!1;for(a in e[r].changed){console.log("Change "+a);for(n in e[r].changed[a])console.log("Change value "+n),e[r].changed[a][n]["new"]!==e[r].changed[a][n].old&&(s[a]||(console.log("Setting new value "+e[r].changed[a][n]["new"]),s[a]={}),s[a][n]=e[r].changed[a][n]["new"],i=!0)}i&&(e[r].saveButton.html("Saving..."),t.post(ajaxurl+"?action=gh_save",{saveData:s},this.returnFunction(this.confirmSave,r)))}},confirmSave:function(t,r){e[t]&&(alert(r),"Error"!==r.substring(0,"Error".length)&&(e[t].changed={}),e[t].saveButton.html("Save Image Changes"))},select:function(t,r){if(e[t]&&e[t].currentImages[r]){var a,n=e[t].currentImages[r].id;e[t].selected[n]&&1==e[t].selected[n].selected?(-1!==(a=e[t].selectOrder.indexOf(n))&&e[t].selectOrder.splice(a,1),e[t].currentImages[r].div.removeClass("selected"),e[t].showingCurrent!==!1?e[t].selected[n].selected=!1:delete e[t].selected[n],this.reOrder(t)):(e[t].selected[n]=e[t].currentImages[r],e[t].selected[n].selected=!0,e[t].selectOrder.push(n),e[t].currentImages[r].order.html(e[t].selectOrder.length),e[t].currentImages[r].div.addClass("selected"),e[t].idsOnly=!0),this.compileShortcode(t)}},reOrder:function(t){if(e[t]){var r,a;for(r in e[t].selectOrder)a=e[t].selectOrder[r],e[t].imageIndex[a]&&e[t].currentImages[e[t].imageIndex[a]].order.html(1*r+1)}},exclude:function(t,r){if(e[t]&&e[t].imageData[r]){var a=e[t].imageData[r].id;e[t].changed[a]||(e[t].changed[a]={}),e[t].changed[a].exclude||(e[t].changed[a].exclude={old:e[t].imageData[r].exclude}),e[t].changed[a].exclude["new"]?(e[t].changed[a].exclude["new"]=!1,e[t].imageData[r].div.removeClass("excluded")):(e[t].changed[a].exclude["new"]=!0,e[t].imageData[r].div.addClass("excluded"))}}}}();
